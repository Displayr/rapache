# DARWIN has to be different than everyone else
# and define their autoconf $shlibpath_var to be DYLD_LIBRARY_PATH
SHLIBPATH_VAR=@SHLIBPATH_VAR@

APXS=@APXS@
HTTPD=@HTTPD@
DOCROOT=@DOCROOT@

APREQ=@APREQ@
APREQ_COMPILE=@APREQ_COMPILE@
APREQ_INSTALL=@APREQ_INSTALL@
APREQ_LIB_DIR=@APREQ_LIB_DIR@

RPROG=@RPROG@
R_HOME = `$(RPROG) RHOME`
R_LD_LIBRARY_PATH = $(R_HOME)/lib

INCLUDES = `$(RPROG) CMD config --cppflags`
LDFLAGS = `$(RPROG) CMD config --ldflags`
LD_LIBRARY_PATH=$(R_LD_LIBRARY_PATH):$(APREQ_LIB_DIR)

all: mod_R.so Rlib/RApache/libs/RApache.so

mod_R.so: .apreq-config mod_R.c mod_R.h
	@echo
	@echo Compiling mod_R
	@echo
	$(APXS) $(INCLUDES) -c mod_R.c $(LDFLAGS)
	@rm -f mod_R.so
	@ln -s .libs/mod_R.so mod_R.so

Rlib/RApache/libs/RApache.so: .apreq-config RApache/src/*.c RApache/man/*.Rd RApache/R/*.R
	@echo
	@echo Compiling RApache
	@echo
	$(RPROG) CMD INSTALL -l ./Rlib RApache

.apreq-config:
	@echo
	@echo Configuring libapreq2
	@echo
	$(APREQ_COMPILE)
	touch .apreq-config

install: all
	$(APXS) -i -n R mod_R.la
	$(RPROG) CMD INSTALL RApache
	$(APREQ_INSTALL)

itest: all
	R_LIBS=./Rlib $(SHLIBPATH_VAR)=$(LD_LIBRARY_PATH) R_HOME=$(R_HOME) $(HTTPD) -X -f $(DOCROOT)/httpd.conf

valgrind: all
	R_LIBS=./Rlib $(SHLIBPATH_VAR)=$(LD_LIBRARY_PATH) R_HOME=$(R_HOME) valgrind $(HTTPD) -X -f $(DOCROOT)/httpd.conf

debug: all
	@echo run -X -f $(DOCROOT)/httpd.conf > gdb.debug
	R_LIBS=./Rlib $(SHLIBPATH_VAR)=$(LD_LIBRARY_PATH) R_HOME=$(R_HOME) gdb -d RApache/src -x ./gdb.debug $(HTTPD)
	@rm -f gdb.debug

rcheck: all
	DRCHECK=-DRCHECK R_LIBS=./Rlib $(SHLIBPATH_VAR)=$(LD_LIBRARY_PATH) R_HOME=$(R_HOME) $(RPROG) CMD check RApache
	
rdoc: all
	echo 'help($(DOC),package="RApache")' | R_LIBS=./Rlib $(SHLIBPATH_VAR)=$(LD_LIBRARY_PATH) R_HOME=$(R_HOME) $(RPROG) --vanilla

clean:
	rm -rf $(OBJS) core mod_R.o mod_R.so *~ .libs *.o *.slo *.lo *.la RApache/src/*.so RApache/src/*.o ./Rlib .apreq-config
	(cd libapreq2; make clean )

distclean: clean
	rm -rf mod_R.h Makefile .depend .install libtool config.log config.status test/httpd.conf test/access_log test/error_log test/httpd.pid test/accept.lock* aclocal.m4 autom4te.cache RApache/src/Makevars RApache.Rcheck libapreq2/library/t/Makefile libapreq2/config.nice libapreq2/module/apache/Makefile
	(cd libapreq2; make distclean )


